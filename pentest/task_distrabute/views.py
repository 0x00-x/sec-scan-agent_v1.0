from django.shortcuts import HttpResponse,HttpResponseRedirect,render_to_response
from django.views.decorators.csrf import csrf_exempt
from pentest.common import *
from pentest.forms import *
from scan_engine.task_contorl import Task_control,Task_basic_control

# Create your views here.
@auth_required
@csrf_exempt
def index(request):
    username = request.COOKIES.get('user_name','')
    return render_to_response("scan/index.html",{'name':username})

@auth_required
@csrf_exempt
def add(request):
    obj_S = Host()
    ret = {'dataS':None,'errorS':''}
    ret['dataS'] = obj_S
    username = request.COOKIES.get('user_name','')
    if request.method == 'POST':
        checkform = Host(request.POST)
        checkresult = checkform.is_valid()
        if checkresult:
            hostname = request.POST.getlist('hostname','')
            scanmodel = request.POST.getlist('scanmodel','')
            plugin = request.POST.get('plugin','').encode('utf-8')
            hostlist = hostname[0].encode('utf-8').split("\r\n")
            pluginlist = plugin.split(",")
            print pluginlist,hostlist
            poc_name = ''
            task_name = ''
            Task_basic_control().launch(hostlist, '', task_name)
        else:
            errorMsg = checkform.errors
            firstErrorMsg = checkform.errors.as_data().values()[0][0].messages[0]
            ret['errorS'] = firstErrorMsg

    return render_to_response('scan/add.html', {'data':ret['dataS'],'name':username,'errorS':ret['errorS']})


@auth_required
@csrf_exempt
def test(request):
    obj_S = Host()
    ret = {'dataS':None,'errorS':''}
    ret['dataS'] = obj_S
    username = request.COOKIES.get('user_name','')
    if request.method == 'POST':
        checkform = Host(request.POST)
        checkresult = checkform.is_valid()
        if checkresult:
            hostname = request.POST.getlist('hostname','')
            scanmodel = request.POST.getlist('scanmodel','')
            plugin = request.POST.get('plugin','').encode('utf-8')
            #print hostname[0].encode('utf-8'),plugin,scanmodel,"####"
            #print type(hostname),type(plugin),type(scanmodel)
            hostlist = hostname[0].encode('utf-8').split("\r\n")
            pluginlist = plugin.split(",")
            print hostlist,pluginlist
        else:
            errorMsg = checkform.errors
            firstErrorMsg = checkform.errors.as_data().values()[0][0].messages[0]
            ret['errorS'] = firstErrorMsg

    return render_to_response('scan/add.html', {'data':ret['dataS'],'name':username,'errorS':ret['errorS']})



def engine(request):
    url_list = ['www.baidu.com','www.sina.com']
    poc_name = ''
    task_name = 'task1'
    Task_basic_control().launch(url_list, poc_name, task_name)
    return HttpResponse("ok")



